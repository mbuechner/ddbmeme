{% extends 'base.html' %}

{% block javascript %}
<script>
    var alertClone;
    var placeholderText;
    var skipNextArchiveSave = false; // prevent auto-generated memes from being archived

    var updateSocialLinks = function () {
        var downloadLink = $('.carousel-inner > .active img').attr('data-src-download');
        $('#saveBtn').attr('href', downloadLink);
        var link = $('.carousel-inner > .active img').attr('src');
        $('#linkToMeme').val(link);
        $('#facebookBtn').attr('href', 'https://www.facebook.com/sharer/sharer.php?p[url]=' + encodeURI(link));
        $('#twitterBtn').attr('href', 'https://x.com/share?url=' + encodeURI(link));
    }

    // Meme Archive (localStorage)
    const ARCHIVE_KEY = 'ddbmeme_archive_v1';
    const ARCHIVE_PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 3'%3E%3Crect width='4' height='3' fill='%23e9ecef'/%3E%3C/svg%3E";

    function getArchive() {
        try {
            const raw = localStorage.getItem(ARCHIVE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            console.warn('Archive parse failed', e);
            return [];
        }
    }

    function setArchive(items) {
        try {
            localStorage.setItem(ARCHIVE_KEY, JSON.stringify(items));
        } catch (e) {
            console.warn('Archive save failed', e);
        }
    }

    function appendArchiveItem(item) {
        var $grid = $('#archiveGrid');
        if (!$grid.length) return;
        var altText = (item.toptext || '') + (item.bottomtext ? (' / ' + item.bottomtext) : '');
        var col = `
                <div class="col">
                    <div class="card archive-card placeholder-glow" data-url="${item.url}" data-download="${item.download || ''}" data-toptext="${(item.toptext || '').replace(/\"/g, '&quot;')}" data-bottomtext="${(item.bottomtext || '').replace(/\"/g, '&quot;')}" data-image="${(item.image || '').replace(/\"/g, '&quot;')}" data-query="${(item.query || '').replace(/\"/g, '&quot;')}" data-uuid="${(item.uuid || '').replace(/\"/g, '&quot;')}">
                        <img src="${item.url}" loading="lazy" class="card-img-top archive-thumb" alt="${altText}">
                    </div>
                </div>`;
        $grid.prepend(col);
    }

    function renderArchive(items) {
        var $grid = $('#archiveGrid');
        if (!$grid.length) return;
        $grid.empty();
        items.forEach(function (item) { appendArchiveItem(item); });
    }

    function saveToArchive(entry) {
        var items = getArchive();
        items.push(entry);
        setArchive(items);
        appendArchiveItem(entry);
    }

    function clearArchive() {
        setArchive([]);
        $('#archiveGrid').empty();
    }

    $(document).ready(function () {
        alertClone = $("#alert").clone();
        placeholderText = $('#id_query').attr('placeholder');

        if ($("#id_query").val().length > 0) {
            $("#id_query").trigger("input");
        }
        $('#id_query').focus(function () {
            $(this).removeAttr('placeholder');
        });
        $('#id_query').focusout(function () {
            $(this).attr('placeholder', placeholderText);
        });
    });

    // Load archive on ready
    $(function () {
        renderArchive(getArchive());
    });

    // Clear archive button
    $(document).on('click', '#clearArchive', function (e) {
        e.preventDefault();
        clearArchive();
    });

    // Restore from archive
    $(document).on('click', '.archive-card', function () {
        var $card = $(this);
        var url = $card.data('url');
        var download = $card.data('download');
        var toptext = $card.data('toptext') || '';
        var bottomtext = $card.data('bottomtext') || '';
        var image = $card.data('image') || '';
        var uuid = $card.data('uuid') || '';
        var query = $card.data('query') || '';

        $('#id_toptext').val(toptext);
        $('#id_bottomtext').val(bottomtext);
        if (image) { $('#id_image').val(image); }

        if ($('.carousel-inner .carousel-item').length === 0) {
            $('.carousel-inner').append('<div class="carousel-item active"><img class="d-block w-100 rounded-0" src="' + url + '" alt="Meme"></div>');
        }
        var $img = $('.carousel-inner > .active img');
        $img.attr('src', url);
        if (download) { $img.attr('data-src-download', download); }

        $('#meme').collapse('show');
        updateSocialLinks();

        // Close offcanvas after selecting an item
        var offc = document.getElementById('offcanvasArchive');
        if (offc && window.bootstrap && bootstrap.Offcanvas) {
            var oc = bootstrap.Offcanvas.getOrCreateInstance(offc);
            oc.hide();
        }

        // Also populate the search URL and trigger image reload, then auto-generate
        if (query) {
            // After images load via search, select the saved image, then generate once (without archiving)
            $(document).one('ddb:imagesLoaded', function () {
                if (uuid || image) {
                    var el = document.getElementById('carouselIndicators');
                    var targetIndex = -1;
                    $('.carousel-inner .carousel-item').each(function (idx) {
                        var $im = $(this).find('img');
                        var ds = $im.attr('data-src');
                        var a = $im.attr('alt');
                        if ((uuid && a === uuid) || (!uuid && image && ds === image)) { targetIndex = idx; return false; }
                    });
                    if (targetIndex >= 0) {
                        if (el && window.bootstrap && bootstrap.Carousel) {
                            var carousel = bootstrap.Carousel.getOrCreateInstance(el);
                            carousel.to(targetIndex);
                        } else {
                            $('.carousel-inner .carousel-item').removeClass('active').eq(targetIndex).addClass('active');
                            $('.carousel-indicators button').removeClass('active').removeAttr('aria-current').eq(targetIndex).addClass('active').attr('aria-current','true');
                        }
                        var chosen = $('.carousel-inner .carousel-item').eq(targetIndex).find('img').attr('data-src');
                        if (chosen) { $('#id_image').val(chosen); }
                        updateSocialLinks();
                    }
                }
                skipNextArchiveSave = true;
                $('#generate').trigger('click');
            });
            $('#id_query').val(query).trigger('input');
        } else {
            // No DDB URL stored: generate immediately with current image + texts (without archiving)
            skipNextArchiveSave = true;
            $('#generate').trigger('click');
        }
    });

    $('#search').on('keyup keypress', function (e) {
        var keyCode = e.keyCode || e.which;
        if (keyCode === 13) {
            e.preventDefault();
            return false;
        }
    });

    $("#id_query").on('input', function () {
        if ($("#id_query").val().length <= 0) {
            $("#alert").replaceWith(alertClone.clone());
            return;
        }
        var form = $(this).closest("form");
        $.ajax({
            url: form.attr("data-validate-query-url"),
            data: form.serialize(),
            dataType: 'json',
            success: function (data) {
                if (data.message) {
                    $("#alert_message").html(data.message);
                    $('#alert').show();
                    $("#alert_example").click(function () {
                        $("#id_query").val($("#alert_example").text());
                        $("#id_query").trigger("input");
                    });
                }
                if (data.images) {
                    $(".carousel-inner").empty();
                    $(".carousel-indicators").empty();
                    $json = JSON.parse(data.images);
                    if ($json.length > 1) {
                        $('.carousel-control-prev, .carousel-control-next, .carousel-indicators').show();
                    } else {
                        $('.carousel-control-prev, .carousel-control-next, .carousel-indicators').hide();
                    }
                    $.each($json, function (key, value) {
                        $(".carousel-inner").append('<div class="carousel-item"><img class="d-block w-100 rounded-0" data-src-download="' + value['image'] + '" data-src="' + value['image'] + '" src="' + value['image'] + '" alt="' + value['uuid'] + '"></div>');
                        $(".carousel-indicators").append('<button type="button" data-bs-target="#carouselIndicators" data-bs-slide-to="' + key + '" aria-label="Slide ' + (key + 1) + '"></button>');
                    });
                    $('.carousel-inner > .carousel-item').first().addClass('active');
                    $('.carousel-indicators > button').first().addClass('active').attr('aria-current', 'true');
                    $('#id_image').val($('.carousel-inner > .active img').attr('data-src'));
                    // Carousel uses Bootstrap data attributes; no manual init needed
                    $('#meme').collapse('show');

                    updateSocialLinks();

                    // Signal that images finished loading to enable chained actions (e.g., auto-generate)
                    $(document).trigger('ddb:imagesLoaded');
                }
            }
        });
    });

    $("#generate").click(function () {
        if ($('#id_toptext').val().length === 0 && $('#id_bottomtext').val().length === 0) {
            return;
        }
        var form = $(this).closest("form");
        $.ajax({
            url: form.attr("data-validate-query-url"),
            data: form.serialize(),
            dataType: 'json',
            beforeSend: function () {
                $('#generate').prop('disabled', true).attr('aria-busy', 'true');
                $('#memeSpinner').removeClass('d-none');
            },
            success: function (data) {
                if (data.url) {
                    $('.carousel-inner > .active img').attr('data-src-download', data.download);
                    $('.carousel-inner > .active img').attr('src', data.url);
                    updateSocialLinks();

                    // Save to archive only when user explicitly generated
                    if (!skipNextArchiveSave) {
                        saveToArchive({
                            url: data.url,
                            download: data.download,
                            toptext: $('#id_toptext').val(),
                            bottomtext: $('#id_bottomtext').val(),
                            image: $('#id_image').val(),
                            query: $('#id_query').val(),
                            uuid: $('.carousel-inner > .active img').attr('alt') || ''
                        });
                    }
                    // reset flag after handling one generate
                    skipNextArchiveSave = false;
                }
            },
            error: function (jqXHR, textStatus, err) {
                console.error('Generate request failed', textStatus, err);
            },
            complete: function () {
                $('#generate').prop('disabled', false).removeAttr('aria-busy');
                $('#memeSpinner').addClass('d-none');
            }
        });
    });

    $("#reset").click(function () {
        $('#id_toptext').val('');
        $('#id_bottomtext').val('');
        $("#id_query").trigger("input");
    });

    $('#carouselIndicators').on('slid.bs.carousel', function () {
        $('#id_image').val($('.carousel-inner > .active img').attr('data-src'));
        updateSocialLinks();
    })
</script>
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<form id="search" method="post" data-validate-query-url="{% url 'autocompletemodel' %}">
    {% csrf_token %}
    <div id="div_id_query" class="form-group">
        <input type="text" name="query" maxlength="128" class="textinput textInput form-control form-control-lg"
            id="id_query"
            placeholder="https://www.deutsche-digitale-bibliothek.de/item/AVSHSWYGR4NBLVXV4IOZRN2PO2KFOEVF">
    </div>
</form>
<div id="alert" class="alert alert-dismissible alert-primary mt-3">
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    <div id="alert_message"><strong>Welcome!</strong> Please fill in the url of the object from <a
            href="https://www.deutsche-digitale-bibliothek.de/" class="alert-link" title="Deutsche Digitale Bibliothek"
            target="_blank">DDB portal</a> you want to use for your meme, or see <a class="alert-link"
            data-bs-toggle="offcanvas" href="#offcanvasArchive" role="button" aria-controls="offcanvasArchive">your
            DDBmeme archive</a>!</div>
</div>
<div class="collapse my-4" id="meme">
    <div class="row">
        <div class="col-md-6">
            <div class="card meme-card position-relative">
                <div id="carouselIndicators" class="carousel carousel-dark slide carousel-fade"
                    data-bs-interval="false">
                    <div class="carousel-indicators"></div>
                    <div class="carousel-inner"></div>
                    <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselIndicators" role="button" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </a>
                </div>
                <!-- Spinner overlay shown while generating/loading -->
                <div id="memeSpinner" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.6); z-index: 10;">
                    <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <br>
            <div class="text-center">
                <a href="#" id="saveBtn" class="socialBtn btn btn-primary" role="button" style="width:3.5em" download>
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                </a>
                <a href="#" id="linkBtn" class="socialBtn btn btn-primary" style="width:3.5em" data-bs-toggle="modal"
                    data-bs-target="#linkModal">
                    <i class="fa-solid fa-link"></i>
                </a>
                <a href="#" id="facebookBtn" class="socialBtn btn btn-primary" style="width:3.5em" target="_blank">
                    <i class="fa-brands fa-facebook"></i>
                </a>
                <a href="#" id="twitterBtn" class="socialBtn btn btn-primary" style="width:3.5em" target="_blank">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
            </div>
        </div>
        <div class="col-md-6">
            <hr class="d-block d-sm-block d-md-none d-lg-none d-xl-none">
            <form id="make" method="post" data-validate-query-url="{% url 'maketextmodel' %}">
                {% csrf_token %}
                <div id="div_id_toptext" class="form-group">
                    <label for="id_toptext" class="col-form-label ">Text top</label>
                    <input type="text" name="toptext" maxlength="128"
                        class="textinput textInput form-control form-control-lg" id="id_toptext"
                        style="text-transform: uppercase;">
                </div>
                <div id="div_id_bottomtext" class="form-group">
                    <label for="id_bottomtext" class="col-form-label ">Text bottom</label>
                    <input type="text" name="bottomtext" maxlength="128"
                        class="textinput textInput form-control form-control-lg" id="id_bottomtext"
                        style="text-transform: uppercase;">
                </div>
                <input type="hidden" class="textinput textInput form-control" name="image" id="id_image">
                <br>
                <button id="generate" type="button" class="btn btn-primary btn-lg">Generate</button>
                <button id="reset" type="button" class="btn btn-secondary btn-lg">Reset</button>
            </form>
        </div>
    </div>
</div>
<!-- Offcanvas Archive -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasArchive" aria-labelledby="offcanvasArchiveLabel"
    style="--bs-offcanvas-width: min(900px, 95vw);">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasArchiveLabel">Your DDBmeme Archive</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="archiveGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
        <button id="clearArchive" type="button" class="btn btn-outline-danger btn-sm clear-archive-fixed">Clear</button>
    </div>
</div>
<div class="modal fade" id="linkModal" tabindex="-1" role="dialog" aria-labelledby="linkModelTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkModelTitle">Link to Meme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-control" id="linkToMeme" placeholder="Link"
                        onClick="this.setSelectionRange(0, this.value.length)" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
